{% extends "base.html" %}

{% block title %}Flujo de Trabajo - {{ proyecto.nombre_proyecto }}{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jkanban@1.3.1/dist/jkanban.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/jkanban@1.3.1/dist/jkanban.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --danger-color: #e74c3c;
        --dark-color: #34495e;
        --card-bg: #ffffff;
        --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .kanban-board header {
        background: linear-gradient(135deg, var(--primary-color), #2980b9);
        color: white;
        padding: 15px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: grab; /* Indica que la columna es movible */
    }
    .kanban-title-board { flex-grow: 1; }
    .board-actions { display: flex; gap: 8px; }
    .board-actions button {
        background: rgba(255,255,255,0.2);
        border: none; border-radius: 4px; color: white;
        cursor: pointer; padding: 5px 8px; transition: background 0.2s;
    }
    .board-actions button:hover { background: rgba(255,255,255,0.4); }
    .kanban-item {
        background: var(--card-bg);
        border-left: 4px solid var(--primary-color);
        box-shadow: var(--card-shadow);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .kanban-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .add-task-btn { width: 100%; margin-top: 10px; background-color: #f0f0f0; border-color: #ddd; }
    .modal-header { background: var(--primary-color); color: white; }
    .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

    /* Estilo para el overlay de carga */
    .loading-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.8); display: flex;
        justify-content: center; align-items: center; z-index: 10;
        border-radius: 8px;
    }
    .spinner {
        width: 40px; height: 40px; border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary-color); border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-1"><i class="fas fa-project-diagram me-2"></i>Flujo de Trabajo: {{ proyecto.nombre_proyecto }}</h2>
        <div>
            <a href="{% url 'proyecto-detail' proyecto.pk %}" class="btn btn-outline-secondary"><i class="fas fa-arrow-left me-2"></i>Volver al Proyecto</a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addColumnModal"><i class="fas fa-plus me-2"></i>Añadir Columna</button>
        </div>
    </div>

    <div id="kanban-board" class="position-relative"></div>
</div>

<div class="modal fade" id="addColumnModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Nueva Columna</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newColumnTitle" class="form-label">Título de la Columna</label>
                    <input type="text" id="newColumnTitle" class="form-control" placeholder="Ej: Tareas Completadas">
                </div>
                <div class="mb-3">
                    <label for="newColumnIcon" class="form-label">Ícono (Opcional)</label>
                    <input type="text" id="newColumnIcon" class="form-control" placeholder="Ej: fas fa-check-circle">
                    <div class="form-text">Busca clases en <a href="https://fontawesome.com/search?o=r&m=free" target="_blank">Font Awesome</a>.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveColumnBtn">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editColumnModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Columna</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editColumnId">
                <div class="mb-3">
                    <label for="editColumnTitle" class="form-label">Título de la Columna</label>
                    <input type="text" id="editColumnTitle" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="editColumnIcon" class="form-label">Ícono (Opcional)</label>
                    <input type="text" id="editColumnIcon" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="updateColumnBtn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gestionar Tarea</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editTaskId">
                <div class="mb-3">
                    <label for="editTaskTitle" class="form-label">Título *</label>
                    <input type="text" class="form-control" id="editTaskTitle" required>
                </div>
                <div class="mb-3">
                    <label for="editTaskDescription" class="form-label">Descripción</label>
                    <textarea class="form-control" id="editTaskDescription" rows="5"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="deleteTaskBtn"><i class="fas fa-trash me-2"></i>Eliminar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="updateTaskBtn"><i class="fas fa-save me-2"></i>Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="quickTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Añadir Tarea Rápida</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="quickTaskTitle" class="form-label">Título de la Tarea</label>
                <input type="text" id="quickTaskTitle" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveQuickTaskBtn">Añadir Tarea</button>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function() {
    const kanbanDataRaw = {{ kanban_data_json|safe }};
    const csrfToken = '{{ csrf_token }}';
    const taskModal = new bootstrap.Modal(document.getElementById('taskModal'));
    const quickTaskModal = new bootstrap.Modal(document.getElementById('quickTaskModal'));
    const editColumnModal = new bootstrap.Modal(document.getElementById('editColumnModal'));
    let currentBoardId = null;
    let kanban;

    function getBoardTitleHTML(icon, title) {
        if (icon && icon.trim() !== '') {
            return `<div><i class="${icon} me-2"></i><span>${title}</span></div>`;
        }
        return `<div><span>${title}</span></div>`;
    }

    function initializeKanban() {
        const initialBoards = kanbanDataRaw.map(board => {
            return {
                ...board,
                title: getBoardTitleHTML(board.icon, board.title)
            };
        });

        kanban = new jKanban({
            element: "#kanban-board",
            gutter: "20px",
            widthBoard: "320px",
            boards: initialBoards,
            dragBoards: true,
            click: (el) => openTaskModal(el.dataset.eid),
            dropEl: (el, target, source, sibling) => handleTaskMove(el.dataset.eid, target.parentElement.dataset.id),
        });

        setupAllBoards();
        setupBoardSorting();
    }
    
    function setupAllBoards() {
        kanban.options.boards.forEach(board => {
            const boardElement = kanban.findBoard(board.id);
            if (boardElement) {
                addBoardActions(board.id);
                addCreateTaskButton(board.id);
            }
        });
    }
    
    function addBoardActions(boardId) {
        const header = kanban.findBoard(boardId).querySelector('header');
        if (header.querySelector('.board-actions')) return;

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'board-actions';
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
        editBtn.title = 'Editar columna';
        editBtn.addEventListener('click', (e) => { e.stopPropagation(); editBoard(boardId); });

        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
        deleteBtn.title = 'Eliminar columna';
        deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteBoard(boardId); });

        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);
        header.appendChild(actionsDiv);
    }

    function addCreateTaskButton(boardId) {
        const taskContainer = kanban.findBoard(boardId).querySelector('.kanban-drag');
        
        const addTaskBtn = document.createElement("button");
        addTaskBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Añadir Tarea';
        addTaskBtn.className = "btn btn-sm add-task-btn";
        addTaskBtn.addEventListener("click", () => {
            currentBoardId = boardId;
            document.getElementById('quickTaskTitle').value = '';
            quickTaskModal.show();
        });
        taskContainer.appendChild(addTaskBtn);
    }

    function setupBoardSorting() {
        const container = document.querySelector('.kanban-container');
        if (container) {
            new Sortable(container, {
                animation: 150,
                handle: '.kanban-board > header',
                onEnd: function(evt) {
                    const orderedIds = Array.from(container.children).map(el => el.dataset.id);
                    fetch("{% url 'api-reordenar-columnas' proyecto.pk %}", {
                        method: 'POST',
                        headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                        body: JSON.stringify({ orden_columnas: orderedIds })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status !== 'success') console.error('Error al guardar el orden de las columnas.');
                    });
                }
            });
        }
    }

    function openTaskModal(taskId) {
        const taskElement = kanban.findElement(taskId);
        if (!taskElement) return;

        document.getElementById('editTaskId').value = taskId;
        document.getElementById('editTaskTitle').value = taskElement.dataset.title || '';
        document.getElementById('editTaskDescription').value = taskElement.dataset.description || '';
        taskModal.show();
    }

    function editBoard(boardId) {
        const originalData = kanbanDataRaw.find(b => b.id === boardId);
        if (!originalData) return;

        document.getElementById('editColumnId').value = boardId;
        document.getElementById('editColumnTitle').value = originalData.title;
        document.getElementById('editColumnIcon').value = originalData.icon || '';
        editColumnModal.show();
    }

    // --- MANEJADORES DE EVENTOS DE BOTONES ---

    document.getElementById("saveColumnBtn").addEventListener("click", function() {
        const title = document.getElementById("newColumnTitle").value;
        const icon = document.getElementById("newColumnIcon").value;
        if (!title.trim()) { alert('El título es obligatorio.'); return; }

        fetch(`{% url 'api-crear-columna' proyecto.pk %}`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
            body: JSON.stringify({ titulo: title, icono: icon }),
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                kanbanDataRaw.push({ id: data.id, title: data.titulo, icon: data.icono, item: [] });
                kanban.addBoards([{ 
                    id: data.id, 
                    title: getBoardTitleHTML(data.icono, data.titulo),
                    item: [] 
                }]);
                addBoardActions(data.id);
                addCreateTaskButton(data.id);
                bootstrap.Modal.getInstance(document.getElementById('addColumnModal')).hide();
            } else { alert('Error al crear la columna.'); }
        });
    });

    document.getElementById("updateColumnBtn").addEventListener("click", function() {
        const boardId = document.getElementById('editColumnId').value;
        const newTitle = document.getElementById('editColumnTitle').value;
        const newIcon = document.getElementById('editColumnIcon').value;

        if (!newTitle.trim()) { alert('El título es obligatorio.'); return; }
        
        fetch(`/api/columna/${boardId}/actualizar/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ titulo: newTitle, icono: newIcon }),
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const boardHeader = kanban.findBoard(boardId).querySelector('header .kanban-title-board');
                boardHeader.innerHTML = getBoardTitleHTML(data.nuevo_icono, data.nuevo_titulo);
                
                let originalData = kanbanDataRaw.find(b => b.id === boardId);
                if (originalData) {
                    originalData.title = data.nuevo_titulo;
                    originalData.icon = data.nuevo_icono;
                }
                editColumnModal.hide();
            } else { alert('Error al actualizar la columna.'); }
        });
    });
    
    document.getElementById("saveQuickTaskBtn").addEventListener("click", function() {
        const title = document.getElementById("quickTaskTitle").value;
        if (!title.trim() || !currentBoardId) return;

        fetch(`/api/columna/${currentBoardId}/tarea/crear/`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
            body: JSON.stringify({ titulo: title }),
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                kanban.addElement(currentBoardId, { 
                    id: data.id, 
                    title: data.titulo,
                    'data-title': data.titulo,
                    'data-description': ''
                });
                quickTaskModal.hide();
            } else { alert('Error al crear la tarea.'); }
        });
    });
    
    document.getElementById('updateTaskBtn').addEventListener('click', function() {
        const taskId = document.getElementById('editTaskId').value;
        const title = document.getElementById('editTaskTitle').value;
        const description = document.getElementById('editTaskDescription').value;

        if (!title.trim()) { alert('El título es obligatorio.'); return; }

        fetch(`/api/tarea/${taskId}/actualizar/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ titulo: title, descripcion: description }),
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const element = kanban.findElement(taskId);
                if (element) {
                    element.innerHTML = data.titulo;
                    element.dataset.title = data.titulo;
                    element.dataset.description = data.descripcion;
                }
                taskModal.hide();
            } else { alert('Error al actualizar la tarea.'); }
        });
    });

    document.getElementById('deleteTaskBtn').addEventListener('click', function() {
        const taskId = document.getElementById('editTaskId').value;
        if (confirm('¿Estás seguro de que quieres eliminar esta tarea?')) {
            fetch(`/api/tarea/${taskId}/eliminar/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    kanban.removeElement(taskId);
                    taskModal.hide();
                } else { alert('Error al eliminar la tarea.'); }
            });
        }
    });

    // --- FUNCIONES PARA LA LÓGICA DEL KANBAN ---

    function handleTaskMove(taskId, newBoardId) {
        fetch(`{% url 'api-mover-tarea' %}`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
            body: JSON.stringify({ tarea_id: taskId, nueva_columna_id: newBoardId }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error('Error al mover la tarea.');
            }
        });
    }

    function deleteBoard(boardId) {
        if (confirm('¿Estás seguro de que quieres eliminar esta columna y todas sus tareas?')) {
            fetch(`/api/columna/${boardId}/eliminar/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    kanban.removeBoard(boardId);
                } else {
                    alert('Error al eliminar la columna.');
                }
            });
        }
    }
    
    initializeKanban();
});
</script>
{% endblock %}