{% extends "base.html" %}

{% block title %}
    {% if diagrama %}
        Editando Diagrama: {{ diagrama.titulo }}
    {% else %}
        Crear Nuevo Diagrama
    {% endif %}
{% endblock %}

{% block content %}
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.5/joint.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

<style>
    :root {
        --primary-color: #4a6cf7;
        --secondary-color: #6c757d;
        --success-color: #198754;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #0dcaf0;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --border-radius: 8px;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
    }
    
    body {
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
    }
    
    .editor-header {
        background: white;
        padding: 15px 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 20px;
    }
    
    .editor-container {
        display: flex;
        height: calc(100vh - 160px);
        gap: 16px;
    }
    
    .toolbar {
        flex: 0 0 280px;
        padding: 16px;
        background-color: white;
        border-radius: var(--border-radius);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        box-shadow: var(--box-shadow);
    }
    
    .toolbar-section {
        margin-bottom: 15px;
    }
    
    .toolbar h5 {
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
        margin-bottom: 15px;
        color: var(--dark-color);
        font-weight: 600;
        font-size: 16px;
        display: flex;
        align-items: center;
    }
    
    .toolbar h5 i {
        margin-right: 8px;
        color: var(--primary-color);
    }
    
    .toolbar .shape, .toolbar .tool, .toolbar .lane-option {
        cursor: pointer;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #e2e8f0;
        background-color: white;
        text-align: left;
        border-radius: var(--border-radius);
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: flex-start;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .toolbar .shape:hover, .toolbar .tool:hover, .toolbar .lane-option:hover {
        background-color: #f1f5f9;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
        border-color: #cbd5e1;
    }
    
    .toolbar .shape i, .toolbar .tool i, .toolbar .lane-option i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
        color: var(--primary-color);
    }
    
    .toolbar .tool.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
    
    .toolbar .tool.active i {
        color: white;
    }
    
    .paper-container {
        flex-grow: 1;
        border-radius: var(--border-radius);
        overflow: hidden;
        position: relative;
        background-color: white;
        box-shadow: var(--box-shadow);
    }
    
    #paper {
        background-color: #f8fafc;
        background-image: 
            linear-gradient(90deg, transparent 99%, rgba(0,0,0,0.03) 99%),
            linear-gradient(transparent 99%, rgba(0,0,0,0.03) 99%);
        background-size: 20px 20px;
    }
    
    .joint-element .body {
        stroke-width: 2px;
    }
    
    .joint-element .label {
        font-size: 14px;
        font-weight: 500;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .paper-overlay {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 100;
        display: flex;
        gap: 8px;
        background: white;
        padding: 10px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }
    
    .paper-overlay button {
        padding: 8px 12px;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        color: var(--dark-color);
    }
    
    .paper-overlay button:hover {
        background: #f1f5f9;
        transform: translateY(-2px);
    }
    
    .zoom-level {
        display: flex;
        align-items: center;
        margin: 0 10px;
        font-weight: 500;
        color: var(--dark-color);
    }
    
    .alignment-guides {
        position: absolute;
        pointer-events: none;
        z-index: 5;
    }
    
    .alignment-guide {
        position: absolute;
        background-color: rgba(74, 108, 247, 0.6);
        z-index: 5;
    }
    
    .horizontal-guide {
        height: 1px;
        width: 100%;
    }
    
    .vertical-guide {
        width: 1px;
        height: 100%;
    }
    
    .resize-handle {
        fill: var(--primary-color);
        stroke: white;
        stroke-width: 1px;
        cursor: nwse-resize;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .joint-element:hover .resize-handle {
        opacity: 1;
    }
    
    .lane {
        stroke-dasharray: 5, 5;
    }
    
    .title-box {
        font-weight: 700;
        font-size: 16px;
    }
    
    .status-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--dark-color);
        color: white;
        padding: 8px 15px;
        font-size: 12px;
        display: flex;
        justify-content: space-between;
        z-index: 10;
    }
    
    .custom-btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    .custom-btn i {
        margin-right: 8px;
    }
    
    .custom-btn-primary {
        background-color: var(--primary-color);
        color: white;
        border: none;
    }
    
    .custom-btn-primary:hover {
        background-color: #3a5be0;
        color: white;
        transform: translateY(-2px);
    }
    
    .custom-btn-outline {
        background-color: transparent;
        color: var(--secondary-color);
        border: 1px solid #e2e8f0;
    }
    
    .custom-btn-outline:hover {
        background-color: #f8fafc;
        color: var(--dark-color);
        transform: translateY(-2px);
    }
    
    #diagram-title {
        border: 1px solid transparent;
        padding: 5px 10px;
        border-radius: 4px;
        transition: var(--transition);
        font-weight: 600;
    }
    
    #diagram-title:focus {
        border-color: var(--primary-color);
        outline: none;
        background-color: #f8fafc;
    }
    
    .shape-badge {
        display: inline-block;
        padding: 2px 8px;
        background: #e2e8f0;
        border-radius: 10px;
        font-size: 11px;
        margin-left: 8px;
        color: var(--dark-color);
    }
</style>

<div class="container-fluid">
    <div class="editor-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1">
                    {% if diagrama %}
                        Editando: <input type="text" id="diagram-title" value="{{ diagrama.titulo }}" class="border-0 bg-transparent">
                    {% else %}
                        <input type="text" id="diagram-title" placeholder="Título del Diagrama" class="border-0 bg-transparent">
                    {% endif %}
                </h4>
                <p class="text-muted mb-0"><i class="fas fa-folder-open me-1"></i> Proyecto: {{ proyecto.nombre_proyecto }}</p>
            </div>
            <div>
                <a href="{% url 'proyecto-detail' proyecto.pk %}" class="custom-btn custom-btn-outline me-2"><i class="fas fa-arrow-left me-2"></i>Volver al Proyecto</a>
                <button id="save-btn" class="custom-btn custom-btn-primary"><i class="fas fa-save me-2"></i>Guardar Diagrama</button>
            </div>
        </div>
    </div>

    <div class="editor-container">
        <div class="toolbar">
            <div class="toolbar-section">
                <h5><i class="fas fa-tools"></i> Herramientas</h5>
                <div class="tool" data-tool="pointer" id="pointer-tool">
                    <i class="fas fa-mouse-pointer"></i> Seleccionar
                </div>
                <div class="tool" data-tool="link" id="link-tool">
                    <i class="fas fa-link"></i> Conectar
                </div>
                <div class="tool" data-tool="delete" id="delete-tool">
                    <i class="fas fa-trash"></i> Eliminar
                </div>
                <div class="tool" data-tool="text" id="text-tool">
                    <i class="fas fa-font"></i> Texto
                </div>
            </div>
            
            <div class="toolbar-section">
                <h5><i class="fas fa-shapes"></i> Figuras</h5>
                <div class="shape" data-type="process"><i class="fas fa-square"></i> Proceso <span class="shape-badge">Ctrl+1</span></div>
                <div class="shape" data-type="decision"><i class="fas fa-gem"></i> Decisión <span class="shape-badge">Ctrl+2</span></div>
                <div class="shape" data-type="startend"><i class="fas fa-capsules"></i> Inicio/Fin <span class="shape-badge">Ctrl+3</span></div>
                <div class="shape" data-type="titlebox"><i class="fas fa-heading"></i> Caja de Título <span class="shape-badge">Ctrl+4</span></div>
                <div class="shape" data-type="data"><i class="fas fa-database"></i> Datos <span class="shape-badge">Ctrl+5</span></div>
            </div>
            
            <div class="toolbar-section">
                <h5><i class="fas fa-road"></i> Carriles</h5>
                <div class="lane-option" data-type="swimlane-h">
                    <i class="fas fa-grip-lines-vertical"></i> Carril Horizontal
                </div>
                <div class="lane-option" data-type="swimlane-v">
                    <i class="fas fa-grip-lines"></i> Carril Vertical
                </div>
            </div>
            
            <div class="toolbar-section">
                <h5><i class="fas fa-magic"></i> Atajos</h5>
                <div class="text-muted small p-2">
                    <p><kbd>Ctrl + Z</kbd> Deshacer</p>
                    <p><kbd>Ctrl + Y</kbd> Rehacer</p>
                    <p><kbd>Del</kbd> Eliminar selección</p>
                    <p><kbd>Ctrl + C</kbd> Copiar</p>
                    <p><kbd>Ctrl + V</kbd> Pegar</p>
                </div>
            </div>
        </div>
        
        <div class="paper-container" id="paper-container">
            <div class="paper-overlay">
                <button id="zoom-out" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
                <span class="zoom-level" id="zoom-level">100%</span>
                <button id="zoom-in" title="Zoom In"><i class="fas fa-search-plus"></i></button>
                <button id="center-content" title="Centrar Contenido"><i class="fas fa-expand-arrows-alt"></i></button>
                <button id="toggle-grid" title="Alternar Rejilla"><i class="fas fa-th"></i></button>
            </div>
            <div id="paper"></div>
            <div class="alignment-guides" id="alignment-guides"></div>
            
            <div class="status-bar">
                <span id="cursor-position">X: 0, Y: 0</span>
                <span id="selected-element-info">Ningún elemento seleccionado</span>
                <span id="selection-count">0 elementos seleccionados</span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.1/backbone.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.5/joint.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
$(document).ready(function() {
    const csrfToken = '{{ csrf_token }}';
    const diagramId = '{{ diagrama.id|default:'' }}';
    const projectId = '{{ proyecto.id }}';
    let currentTool = 'pointer';
    let selectedElement = null;
    let isResizing = false;
    let resizeData = null;
    let alignmentGuides = [];
    let zoomLevel = 1;
    let clipboard = null;
    let history = [];
    let historyIndex = -1;

    // 1. Inicializar el Grafo y el Lienzo (Paper)
    const namespace = joint.shapes;
    const graph = new joint.dia.Graph({}, { cellNamespace: namespace });
    const paper = new joint.dia.Paper({
        el: document.getElementById('paper'),
        model: graph,
        width: 3000,
        height: 2000,
        gridSize: 10,
        drawGrid: true,
        background: { color: 'rgba(255, 255, 255, 0.9)' },
        cellViewNamespace: namespace,
        defaultLink: () => new joint.shapes.standard.Link({
            attrs: {
                line: {
                    stroke: '#4a6cf7',
                    strokeWidth: 2,
                    targetMarker: { 
                        'type': 'path',
                        'd': 'M 10 -5 0 0 10 5 Z',
                        'fill': '#4a6cf7',
                        'stroke': 'none'
                    }
                }
            },
            router: { 
                name: 'manhattan',
                args: {
                    step: 10,
                    padding: 5
                }
            },
            connector: { name: 'rounded' },
            labels: [
                {
                    position: 0.5,
                    attrs: {
                        text: {
                            text: '',
                            fill: '#334155',
                            fontSize: 12,
                            fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif'
                        },
                        rect: {
                            fill: 'white',
                            stroke: '#cbd5e1',
                            strokeWidth: 1,
                            rx: 3,
                            ry: 3
                        }
                    }
                }
            ]
        }),
        validateConnection: function(cellViewS, magnetS, cellViewT, magnetT, end, linkView) {
            // No permitir conexiones consigo mismo
            if (cellViewS === cellViewT) return false;
            // Solo permitir conexiones a puertos válidos
            return magnetT && magnetT.getAttribute('port');
        },
        interactive: true,
        movable: true,
        linkPinning: true,
        markAvailable: true,
        snapLinks: { radius: 20 }
    });

    // Función para guardar el estado en el historial
    function saveHistory() {
        // Limitar el historial a 100 estados
        if (historyIndex < history.length - 1) {
            history = history.slice(0, historyIndex + 1);
        }
        
        history.push(JSON.stringify(graph.toJSON()));
        historyIndex = history.length - 1;
        
        // Limitar el historial a 100 estados
        if (history.length > 100) {
            history.shift();
            historyIndex = history.length - 1;
        }
    }

    // Función para deshacer
    function undo() {
        if (historyIndex > 0) {
            historyIndex--;
            graph.fromJSON(JSON.parse(history[historyIndex]));
        }
    }

    // Función para rehacer
    function redo() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            graph.fromJSON(JSON.parse(history[historyIndex]));
        }
    }

    // Inicializar historial
    saveHistory();

    // Configurar atajos de teclado
    $(document).on('keydown', function(e) {
        // Ctrl+Z para deshacer
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            undo();
        }
        
        // Ctrl+Y para rehacer
        if (e.ctrlKey && e.key === 'y') {
            e.preventDefault();
            redo();
        }
        
        // Ctrl+C para copiar
        if (e.ctrlKey && e.key === 'c' && selectedElement) {
            e.preventDefault();
            clipboard = selectedElement.clone();
        }
        
        // Ctrl+V para pegar
        if (e.ctrlKey && e.key === 'v' && clipboard) {
            e.preventDefault();
            const newElement = clipboard.clone();
            newElement.translate(20, 20);
            newElement.addTo(graph);
            selectedElement = newElement;
            saveHistory();
        }
        
        // Delete para eliminar
        if (e.key === 'Delete' && selectedElement) {
            e.preventDefault();
            selectedElement.remove();
            selectedElement = null;
            saveHistory();
        }
        
        // Atajos para formas
        if (e.ctrlKey && e.key >= '1' && e.key <= '5') {
            e.preventDefault();
            const center = getVisibleAreaCenter();
            const shapes = ['process', 'decision', 'startend', 'titlebox', 'data'];
            const shapeType = shapes[parseInt(e.key) - 1];
            addShape(shapeType, center.x, center.y);
        }
    });

    // Función para obtener la vista visible del papel
    function getVisibleAreaCenter() {
        const paperArea = paper.getArea();
        const visibleCenter = {
            x: paperArea.x + paperArea.width / 2,
            y: paperArea.y + paperArea.height / 2
        };
        return paper.clientToLocalPoint(visibleCenter);
    }

    // 2. Funciones para añadir figuras con puertos para conexiones
    function addShape(type, x, y) {
        let element;
        
        switch(type) {
            case 'process':
                element = addProcess(x, y);
                break;
            case 'decision':
                element = addDecision(x, y);
                break;
            case 'startend':
                element = addStartEnd(x, y);
                break;
            case 'titlebox':
                element = addTitleBox(x, y);
                break;
            case 'data':
                element = addData(x, y);
                break;
        }
        
        saveHistory();
        return element;
    }

    function addProcess(x, y) {
        const rect = new joint.shapes.standard.Rectangle({
            position: { x: x - 60, y: y - 30 },
            size: { width: 120, height: 60 },
            attrs: {
                body: { 
                    fill: '#3498db', 
                    rx: 5, 
                    ry: 5, 
                    stroke: '#2980b9',
                    strokeWidth: 2
                },
                label: { 
                    text: 'Proceso', 
                    fill: 'white',
                    fontSize: 14,
                    fontWeight: 'bold',
                    fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                    textWrap: {
                        width: -10,
                        height: -10,
                        ellipsis: true
                    }
                }
            },
            ports: {
                groups: {
                    'in': {
                        position: { name: 'left' },
                        attrs: {
                            circle: {
                                r: 5,
                                magnet: true,
                                stroke: '#3498db',
                                strokeWidth: 2,
                                fill: 'white'
                            }
                        }
                    },
                    'out': {
                        position: { name: 'right' },
                        attrs: {
                            circle: {
                                r: 5,
                                magnet: true,
                                stroke: '#3498db',
                                strokeWidth: 2,
                                fill: 'white'
                            }
                        }
                    }
                },
                items: [
                    { group: 'in', id: 'in1' },
                    { group: 'out', id: 'out1' }
                ]
            }
        });
        
        rect.addTo(graph);
        return rect;
    }

    function addDecision(x, y) {
        const rhombus = new joint.shapes.standard.Polygon({
            position: { x: x - 60, y: y - 40 },
            size: { width: 120, height: 80 },
            attrs: {
                body: {
                    refPoints: '50,0 100,50 50,100 0,50',
                    fill: '#f1c40f', 
                    stroke: '#f39c12',
                    strokeWidth: 2
                },
                label: { 
                    text: '¿Decisión?', 
                    fill: 'black',
                    fontSize: 14,
                    fontWeight: 'bold',
                    fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                    textWrap: {
                        width: -10,
                        height: -10,
                        ellipsis: true
                    }
                }
            },
            ports: {
                groups: {
                    'in': {
                        position: { name: 'top' },
                        attrs: {
                            circle: {
                                r: 5,
                                magnet: true,
                                stroke: '#f1c40f',
                                strokeWidth: 2,
                                fill: 'white'
                            }
                        }
                    },
                    'out': {
                        position: { name: 'bottom' },
                        attrs: {
                            circle: {
                                r: 5,
                                magnet: true,
                                stroke: '#f1c40f',
                                strokeWidth: 2,
                                fill: 'white'
                            }
                        }
                    }
                },
                items: [
                    { group: 'in', id: 'in1' },
                    { group: 'out', id: 'out1' },
                    { group: 'out', id: 'out2' }
                ]
            }
        });
        rhombus.addTo(graph);
        return rhombus;
    }

    function addStartEnd(x, y) {
        const ellipse = new joint.shapes.standard.Ellipse({
            position: { x: x - 60, y: y - 25 },
            size: { width: 120, height: 50 },
            attrs: {
                body: { 
                    fill: '#2ecc71', 
                    stroke: '#27ae60',
                    strokeWidth: 2
                },
                label: { 
                    text: 'Inicio', 
                    fill: 'white',
                    fontSize: 14,
                    fontWeight: 'bold',
                    fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                    textWrap: {
                        width: -10,
                        height: -10,
                        ellipsis: true
                    }
                }
            },
            ports: {
                groups: {
                    'out': {
                        position: { name: 'right' },
                        attrs: {
                            circle: {
                                r: 5,
                                magnet: true,
                                stroke: '#2ecc71',
                                strokeWidth: 2,
                                fill: 'white'
                            }
                        }
                    }
                },
                items: [
                    { group: 'out', id: 'out1' }
                ]
            }
        });
        ellipse.addTo(graph);
        return ellipse;
    }

    function addTitleBox(x, y) {
        const rect = new joint.shapes.standard.Rectangle({
            position: { x: x - 100, y: y - 30 },
            size: { width: 200, height: 60 },
            attrs: {
                body: { 
                    fill: 'transparent', 
                    stroke: '#7f8c8d',
                    strokeWidth: 2,
                    strokeDasharray: '5,5'
                },
                label: { 
                    text: 'Título', 
                    fill: '#2c3e50',
                    fontSize: 18,
                    fontWeight: 800,
                    fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                    textWrap: {
                        width: -10,
                        height: -10,
                        ellipsis: true
                    },
                    class: 'title-box'
                }
            }
        });
        rect.addTo(graph);
        return rect;
    }

    function addData(x, y) {
        const path = new joint.shapes.standard.Path({
            position: { x: x - 60, y: y - 30 },
            size: { width: 120, height: 60 },
            attrs: {
                body: {
                    d: 'M 0 10 C 10 0 30 0 40 10 L 80 10 C 90 0 110 0 120 10 L 120 50 C 110 60 90 60 80 50 L 40 50 C 30 60 10 60 0 50 Z',
                    fill: '#9b59b6',
                    stroke: '#8e44ad',
                    strokeWidth: 2
                },
                label: {
                    text: 'Datos',
                    fill: 'white',
                    fontSize: 14,
                    fontWeight: 'bold',
                    fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                    textWrap: {
                        width: -10,
                        height: -10,
                        ellipsis: true
                    }
                }
            },
            ports: {
                groups: {
                    'in': {
                        position: { name: 'left' },
                        attrs: {
                            circle: {
                                r: 5,
                                magnet: true,
                                stroke: '#9b59b6',
                                strokeWidth: 2,
                                fill: 'white'
                            }
                        }
                    },
                    'out': {
                        position: { name: 'right' },
                        attrs: {
                            circle: {
                                r: 5,
                                magnet: true,
                                stroke: '#9b59b6',
                                strokeWidth: 2,
                                fill: 'white'
                            }
                        }
                    }
                },
                items: [
                    { group: 'in', id: 'in1' },
                    { group: 'out', id: 'out1' }
                ]
            }
        });
        path.addTo(graph);
        return path;
    }

    function addSwimlane(isHorizontal, x, y) {
        const lane = new joint.shapes.standard.Rectangle({
            position: { x: isHorizontal ? x - 500 : x - 75, y: isHorizontal ? y - 75 : y - 500 },
            size: isHorizontal ? { width: 1000, height: 150 } : { width: 150, height: 1000 },
            attrs: {
                body: { 
                    fill: 'rgba(236, 240, 241, 0.5)', 
                    stroke: '#7f8c8d',
                    strokeWidth: 2,
                    strokeDasharray: '5,5',
                    class: 'lane'
                },
                label: { 
                    text: isHorizontal ? 'Carril Horizontal' : 'Carril Vertical', 
                    fill: '#2c3e50',
                    fontSize: 14,
                    fontWeight: 'bold',
                    fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                    textAnchor: 'middle',
                    textVerticalAnchor: 'middle',
                    x: isHorizontal ? 500 : 75,
                    y: isHorizontal ? 20 : 500
                }
            },
            z: -1 // Enviar al fondo
        });
        lane.addTo(graph);
        saveHistory();
        return lane;
    }

    // 3. Eventos de la barra de herramientas
    $('.toolbar .shape, .toolbar .lane-option').on('click', function() {
        const type = $(this).data('type');
        const center = getVisibleAreaCenter();
        
        if (type === 'process') addShape('process', center.x, center.y);
        if (type === 'decision') addShape('decision', center.x, center.y);
        if (type === 'startend') addShape('startend', center.x, center.y);
        if (type === 'titlebox') addShape('titlebox', center.x, center.y);
        if (type === 'data') addShape('data', center.x, center.y);
        if (type === 'swimlane-h') addSwimlane(true, center.x, center.y);
        if (type === 'swimlane-v') addSwimlane(false, center.x, center.y);
    });

    // 4. Cambiar entre herramientas
    $('.toolbar .tool').on('click', function() {
        $('.toolbar .tool').removeClass('active');
        $(this).addClass('active');
        
        currentTool = $(this).data('tool');
        
        switch(currentTool) {
            case 'pointer':
                paper.options.interactive = true;
                paper.options.movable = true;
                paper.options.linkPinning = false;
                break;
            case 'link':
                paper.options.interactive = true;
                paper.options.movable = false;
                paper.options.linkPinning = true;
                break;
            case 'delete':
                paper.options.interactive = true;
                paper.options.movable = false;
                paper.options.linkPinning = false;
                break;
            case 'text':
                paper.options.interactive = true;
                paper.options.movable = false;
                paper.options.linkPinning = false;
                break;
        }
    });

    // 5. Permitir editar texto al hacer doble clic
    paper.on('element:pointerdblclick', (elementView, evt) => {
        const currentText = elementView.model.attr('label/text');
        Swal.fire({
            title: 'Editar Texto',
            input: 'textarea',
            inputValue: currentText,
            showCancelButton: true,
            confirmButtonText: 'Guardar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                elementView.model.attr('label/text', result.value);
                saveHistory();
            }
        });
    });

    // 6. Eliminar elementos con la herramienta de eliminación
    paper.on('element:pointerclick', (elementView, evt) => {
        if (currentTool === 'delete') {
            Swal.fire({
                title: '¿Estás seguro?',
                text: 'No podrás revertir esto',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    elementView.model.remove();
                    saveHistory();
                    Swal.fire('Eliminado!', 'El elemento ha sido eliminado.', 'success');
                }
            });
        } else {
            selectedElement = elementView.model;
            $('#selected-element-info').text(selectedElement.attr('label/text') || 'Elemento seleccionado');
        }
    });

    // 7. Eliminar enlaces con la herramienta de eliminación
    paper.on('link:pointerclick', (linkView, evt) => {
        if (currentTool === 'delete') {
            Swal.fire({
                title: '¿Estás seguro?',
                text: 'No podrás revertir esto',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    linkView.model.remove();
                    saveHistory();
                    Swal.fire('Eliminado!', 'La conexión ha sido eliminada.', 'success');
                }
            });
        }
    });

    // 8. Funciones de zoom
    $('#zoom-in').on('click', function() {
        zoomLevel += 0.1;
        paper.scale(zoomLevel, zoomLevel);
        $('#zoom-level').text(Math.round(zoomLevel * 100) + '%');
    });

    $('#zoom-out').on('click', function() {
        if (zoomLevel > 0.2) {
            zoomLevel -= 0.1;
            paper.scale(zoomLevel, zoomLevel);
            $('#zoom-level').text(Math.round(zoomLevel * 100) + '%');
        }
    });

    $('#center-content').on('click', function() {
        zoomLevel = 1;
        paper.scale(1, 1);
        paper.translate(0, 0);
        $('#zoom-level').text('100%');
    });

    $('#toggle-grid').on('click', function() {
        const currentGridSize = paper.options.gridSize;
        paper.options.gridSize = currentGridSize === 1 ? 10 : 1;
        paper.options.drawGrid = currentGridSize !== 1;
        paper.render();
    });

    // 9. Seguimiento del cursor
    paper.on('blank:pointermove', (evt, x, y) => {
        $('#cursor-position').text(`X: ${Math.round(x)}, Y: ${Math.round(y)}`);
    });

    paper.on('element:pointermove', (elementView, evt, x, y) => {
        $('#cursor-position').text(`X: ${Math.round(x)}, Y: ${Math.round(y)}`);
    });

    // 10. Actualizar información de selección
    paper.on('blank:pointerclick', () => {
        selectedElement = null;
        $('#selected-element-info').text('Ningún elemento seleccionado');
    });

    // 11. Lógica de guardado mejorada
    $('#save-btn').on('click', function() {
        const title = $('#diagram-title').val().trim();
        if (!title) {
            Swal.fire('Error', 'Por favor, introduce un título para el diagrama.', 'error');
            return;
        }

        paper.toSVG(svgString => {
            const dataToSave = {
                // El ID se envía en el cuerpo. La vista lo usará para saber si debe crear o actualizar.
                id: diagramId || null, 
                titulo: title,
                // graph.toJSON() devuelve un objeto JS, lo convertimos a string JSON para el backend.
                codigo: JSON.stringify(graph.toJSON()),
                svg: svgString
            };
            
            // --- CÓDIGO CORREGIDO ---
            // 1. Usamos la URL correcta que definiste en urls.py
            const url = `/api/proyecto/${projectId}/guardar-diagrama/`;
            // 2. El método siempre es POST, como espera tu vista.
            const method = 'POST';

            // Muestra una notificación de carga
            Swal.fire({
                title: 'Guardando...',
                text: 'Por favor, espera.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                // 3. El cuerpo del request se envía como string JSON.
                //    La vista Django lo parseará correctamente.
                body: JSON.stringify(dataToSave)
            })
            .then(response => {
                Swal.close();
                if (!response.ok) {
                    // Si la respuesta no es OK, lanzamos un error para que lo capture el .catch()
                    return response.json().then(err => { throw new Error(err.message || 'Error al guardar el diagrama.'); });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    Swal.fire('¡Guardado!', 'El diagrama se ha guardado con éxito.', 'success').then(() => {
                        // Si antes no había un ID, significa que creamos un nuevo diagrama.
                        // Redirigimos a la nueva URL de edición para evitar duplicados al guardar de nuevo.
                        if (!diagramId) {
                            window.location.href = `/diagrama/${data.diagrama_id}/editar/`;
                        } else {
                            // Opcional: podrías simplemente recargar o no hacer nada si solo se actualizó.
                            location.reload(); 
                        }
                    });
                } else {
                    Swal.fire('Error', data.message || 'Ocurrió un error inesperado al guardar.', 'error');
                }
            })
            .catch(error => {
                Swal.close();
                console.error('Error de red:', error);
                Swal.fire('Error de red', 'No se pudo conectar con el servidor. ' + error.message, 'error');
            });
        }, { preserveDimensions: true }); // Añadido para mejor calidad de SVG
    });

    // 12. Cargar datos del diagrama si estamos en modo edición
    if (diagramId) {
        fetch(`/api/diagrama/${diagramId}/`)
            .then(response => response.json())
            .then(data => {
                // El campo 'codigo' en la respuesta de la API ya es un objeto JSON
                graph.fromJSON(data.codigo);
                // Ajustar la vista para mostrar todo el diagrama
                paper.scaleContentToFit({ padding: 50 });
                zoomLevel = paper.scale().sx;
                $('#zoom-level').text(Math.round(zoomLevel * 100) + '%');
                saveHistory();
            })
            .catch(error => console.error('Error al cargar el diagrama:', error));
    }

    // Activar la herramienta de selección por defecto
    $('#pointer-tool').addClass('active');
    
    // Inicializar el nivel de zoom
    $('#zoom-level').text('100%');
    
    // Guardar historial cuando cambien los elementos
    graph.on('change', _.debounce(saveHistory, 500));
});
</script>
{% endblock %}